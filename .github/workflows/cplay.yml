name: CPLAY COSTOM TV

on:
  schedule:
    - cron: '*/30 * * * *'
  workflow_dispatch:

permissions:
  contents: write
  actions: read

concurrency:
  group: auto-update-m3u
  cancel-in-progress: true

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout main branch
        uses: actions/checkout@v4
        with:
          ref: main
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Generate cplaytv.m3u
        shell: bash
        run: |
          set -e

          MAIN_JSON_URL="${{ secrets.MAIN_JSON_URL }}"
          COOKIE_JSON_URL="${{ secrets.COOKIE_JSON_URL }}"

          echo "ðŸ“¥ Fetching main JSON..."
          curl -sS --fail "$MAIN_JSON_URL" -o main.json

          echo "ðŸ“¥ Fetching cookie JSON..."
          curl -sS --fail "$COOKIE_JSON_URL" -o cookie.json

          jq -e . main.json > /dev/null
          jq -e . cookie.json > /dev/null

          echo "#EXTM3U" > cplaytv.m3u

          cat << 'EOF' > filter.jq
          def normalize:
            if type == "array" then .
            elif type == "object" then
              (.channels // .data // .list // [])
            else []
            end;

          normalize
          | map(select(type == "object"))
          | .[]
          | (.name // .title // .channel_name // "Unknown") as $name
          | (.["tvg-id"]? // .tvgId? // .id? // "") as $tvg_id
          | (.["tvg-language"]? // .language? // .lang? // "") as $tvg_language
          | (.["tvg-logo"]? // .logo? // .icon? // "") as $tvg_logo
          | (.link? // .url? // .stream_url? // .hls? // .mpd? // "") as $link
          | select($link != "")
          | "#EXTINF:-1 " +
            (if $tvg_id != "" then "tvg-id=\"\($tvg_id)\" " else "" end) +
            (if $tvg_language != "" then "tvg-language=\"\($tvg_language)\" " else "" end) +
            "group-title=\"" +
              (if $tvg_language != "" then $tvg_language else "Unknown" end)
            + "\" " +
            (if $tvg_logo != "" then "tvg-logo=\"\($tvg_logo)\" " else "" end) +
            ",\($name)",
          $link
          EOF

          jq -r -f filter.jq main.json >> cplaytv.m3u

          LINE_COUNT=$(wc -l < cplaytv.m3u)
          if [ "$LINE_COUNT" -le 1 ]; then
            echo "âŒ cplaytv.m3u is empty"
            exit 1
          fi

          echo "âœ… cplaytv.m3u created ($LINE_COUNT lines)"

      - name: Commit & Push
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"

          git add cplaytv.m3u

          if git diff --cached --quiet; then
            echo "âž¡ï¸ No changes â€” skipping commit"
            exit 0
          fi

          git commit -m "CPLAY Auto-update M3U: $(date -u '+%Y-%m-%d %H:%M')"
          git push origin main
