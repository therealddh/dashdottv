name: CPLAY COSTOM TV

on:
  schedule:
    - cron: '*/30 * * * *'
  workflow_dispatch:

permissions:
  contents: write
  actions: read

concurrency:
  group: auto-update-m3u
  cancel-in-progress: true

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout main branch
        uses: actions/checkout@v4
        with:
          ref: main
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Generate cplaytv.m3u
        run: |
          echo "ðŸ“¥ Fetching main JSON..."
          MAIN_JSON_URL="${{ secrets.MAIN_JSON_URL }}"
          MAIN_JSON=$(curl -sS --fail \
            --connect-timeout 15 \
            --max-time 30 \
            --retry 3 \
            --retry-delay 5 \
            -H "User-Agent: plaYtv/7.1.5 (Linux;Android 15) ExoPlayerLib/2.11.6" \
            -H "Accept: application/json,text/plain,*/*" \
            "$MAIN_JSON_URL") || { echo "âŒ Failed to fetch main JSON"; exit 1; }

          echo "ðŸ“¥ Fetching cookie JSON..."
          COOKIE_JSON_URL="${{ secrets.COOKIE_JSON_URL }}"
          COOKIE_JSON=$(curl -sS --fail \
            --connect-timeout 15 \
            --max-time 30 \
            --retry 3 \
            --retry-delay 5 \
            -H "User-Agent: Mozilla/5.0" \
            -H "Accept: application/json" \
            "$MAIN_JSON_URL") || { echo "âŒ Failed to fetch main JSON"; exit 1; }

          # Validate JSON
          echo "$MAIN_JSON" | jq -e . > /dev/null || { echo "âŒ Invalid main JSON"; exit 1; }
          echo "$COOKIE_JSON" | jq -e . > /dev/null || { echo "âŒ Invalid cookie JSON"; exit 1; }

          echo "#EXTM3U" > cplaytv.m3u

          # Extract global cookie
          GLOBAL_COOKIE=$(echo "$COOKIE_JSON" | jq -r '
            if type=="object" and has("cookie") then .cookie
            elif type=="object" and has("cookies") then .cookies
            elif type=="array" and length>0 and .[0].cookie then .[0].cookie
            else ""
            end
          ')

          echo "$MAIN_JSON" | jq -r --arg cookie "$GLOBAL_COOKIE" '

          def normalize:
            if type == "array" then .
            elif type == "object" then
              if has("channels") and (.channels | type == "array") then .channels
              elif has("data") and (.data | type == "array") then .data
              elif has("list") and (.list | type == "array") then .list
              elif (.[] | type == "object") then [.[]]
              else []
              end
            else []
            end;

          normalize |
          map(select(type == "object")) |
          .[] |

          (.name // .title // .channel_name // "Unknown") as $name |
          (.tvg-id // .tvgId // .id // "") as $tvg_id |
          # Attempt to find a language field, fallback to empty string if not found
          (.tvg-language // .language // .lang // "") as $tvg_language |
          (.tvg-logo // .logo // .icon // "") as $tvg_logo |
          (.drmScheme // .drm_scheme // .drm // "") as $drmScheme |
          (.drmLicense // .license // "") as $drmLicense |
          (.link // .url // .stream_url // .hls // .mpd // "") as $link |
          
          if ($link | length) == 0 then empty else
          
            # Construct the #EXTINF line with tvg-language
            "#EXTINF:-1 " +
            (if ($tvg_id | length > 0) then "tvg-id=\"\($tvg_id)\" " else "" end) +
            (if ($tvg_language | length > 0) then "tvg-language=\"\($tvg_language)\" " else "" end) +
            "group-title=\"\($tvg_language // "Unknown")\" " +
            (if ($tvg_logo | length > 0) then "tvg-logo=\"\($tvg_logo)\" " else "" end) +
            ",\($name | gsub(","; "\\,"))" |
          . as $extinf |

          (if ($drmScheme == "clearkey") and ($drmLicense | test("^[a-zA-Z0-9]+:[a-zA-Z0-9]+")) then
            "#KODIPROP:inputstream.adaptive.license_type=clearkey\n#KODIPROP:inputstream.adaptive.license_key=" + 
            ($drmLicense | split(":")[0:2] | join(":"))
          else "" end) as $drm |

          "#EXTVLCOPT:http-user-agent=plaYtv/7.1.5%20(Linux%3BAndroid%2015)%20ExoPlayerLib/2.11.6%20YGX/69.69.69.69" as $ua |

          (if ($cookie | length > 0) then
            "#EXTHTTP:{\"cookie\":\"" + ($cookie | gsub("\n"; "") | gsub("\""; "\\\"")) + "\"}"
          else "" end) as $cookie_line |

          [
            $extinf,
            ($drm | select(. != "")),
            $ua,
            ($cookie_line | select(. != "")),
            $link
          ] | join("\n")

          end
          ' >> cplaytv.m3u

          sed -i 's/[[:space:]]*$//' jiotv.m3u

          LINE_COUNT=$(wc -l < cplaytv.m3u)
          if [ "$LINE_COUNT" -le 1 ]; then
            echo "âŒ cplaytv.m3u is empty"
            exit 1
          fi

          echo "âœ… cplaytv.m3u created ($LINE_COUNT lines)"

      - name: Commit & Push
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add cplaytv.m3u

          if git diff --cached --quiet; then
            echo "âž¡ï¸ No changes â€” skipping commit"
            exit 0
          fi

          git commit -m "CPLAY Auto-update M3U: $(date -u '+%Y-%m-%d %H:%M')"
          git push origin main
